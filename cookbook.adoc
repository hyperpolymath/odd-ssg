= odd-ssg Cookbook
:toc: left
:toclevels: 3
:icons: font
:source-highlighter: highlight.js

== Introduction

This cookbook provides recipes for common tasks with odd-ssg, organized by tooling category.

== Quick Reference

[cols="1,2,3"]
|===
|Tool |Command |Description

|Just
|`just build`
|Build the project

|Deno
|`deno task test`
|Run tests

|MCP
|`just mcp`
|Start MCP server

|Container
|`just container-build`
|Build container image
|===

[[cli]]
== CLI Commands

=== Justfile Commands

[source,bash]
----
# Build commands
just build              # Build the project
just build-verbose      # Build with verbose output
just build-drafts       # Build including draft content
just clean              # Clean build artifacts
just watch              # Watch for changes and rebuild

# Test commands
just test               # Run all tests
just test-unit          # Run unit tests only
just test-e2e           # Run end-to-end tests
just test-coverage      # Run tests with coverage
just test-watch         # Run tests in watch mode
just test-bernoulli     # Run Bernoulli verification tests
just test-all           # Run all test types

# Language server & tooling
just lsp                # Start the language server
just compile <file>     # Compile a .noteg file
just lint               # Lint the codebase
just fmt                # Format the codebase
just check              # Check types

# Development
just dev                # Start development server
just mcp                # Run the MCP server
just codegen            # Generate types from schema

# Adapters
just test-adapters      # Test all SSG adapters
just list-adapters      # List available adapters
just check-adapters     # Check adapter syntax

# Accessibility
just a11y-validate      # Validate accessibility schema
just a11y-report        # Generate accessibility report

# Container & deployment
just container-build    # Build container image
just container-run      # Run in container
just container-push     # Push to registry

# Documentation
just docs               # Generate documentation
just docs-serve         # Serve documentation locally

# Release & CI
just release <version>  # Prepare release
just ci                 # CI pipeline simulation
just pre-commit         # Pre-commit checks

# Utilities
just info               # Show project info
just update             # Update dependencies
just lock               # Generate lockfile
just deno <args>        # Run arbitrary deno command
----

=== Deno Tasks

[source,bash]
----
deno task build         # Build site
deno task dev           # Start dev server
deno task watch         # Watch mode build
deno task test          # Run all tests
deno task test:unit     # Unit tests only
deno task test:e2e      # E2E tests only
deno task test:coverage # Tests with coverage
deno task coverage      # View coverage report
deno task lint          # Run linter
deno task fmt           # Format code
deno task check         # Type check
deno task mcp           # Run MCP server
deno task lsp           # Run language server
----

=== CLI Combinatorics

==== Build Variations

[source,bash]
----
# Basic builds
just build
just build-verbose
just build-drafts

# Combined with watch
just watch

# Build and test
just build && just test

# Full CI simulation
just ci
----

==== Test Combinations

[source,bash]
----
# Individual test types
just test-unit
just test-e2e
just test-bernoulli

# Combined testing
just test-all

# With coverage
just test-coverage && deno coverage coverage/

# Watch mode for TDD
just test-watch
----

==== Pre-commit Workflow

[source,bash]
----
# Full pre-commit (recommended)
just pre-commit

# Individual steps
just fmt && just lint && just check && just test-unit

# Quick check
just check && just test-unit
----

[[nickel]]
== Nickel Configuration

=== Site Configuration Schema

[source,nickel]
----
# odd-ssg.ncl - Site configuration in Nickel

let SiteConfig = {
  title : String,
  description : String | optional,
  baseUrl : String,
  language : String | default = "en",
  author : {
    name : String,
    email : String | optional,
    url : String | optional,
  } | optional,
  build : {
    contentDir : String | default = "content",
    templateDir : String | default = "templates",
    outputDir : String | default = "dist",
    drafts : Bool | default = false,
    minify : Bool | default = true,
    sitemap : Bool | default = true,
    rss : Bool | default = true,
  },
  accessibility : {
    bsl : Bool | default = false,
    asl : Bool | default = false,
    gsl : Bool | default = false,
    makaton : Bool | default = false,
    easyRead : Bool | default = false,
    wcagLevel : [| 'A, 'AA, 'AAA |] | default = 'AA,
  },
}

in SiteConfig
----

=== Adapter Configuration

[source,nickel]
----
# adapter-config.ncl - Adapter-specific settings

let AdapterConfig = {
  name : String,
  binary : String,
  defaultArgs : Array String | default = [],
  env : { _ : String } | default = {},
  timeout : Number | default = 300000,
}

let ZolaConfig : AdapterConfig = {
  name = "zola",
  binary = "zola",
  defaultArgs = [],
  timeout = 300000,
}

let HakyllConfig : AdapterConfig = {
  name = "hakyll",
  binary = "site",
  defaultArgs = [],
  timeout = 600000,
}

in { zola = ZolaConfig, hakyll = HakyllConfig }
----

=== Build Pipeline Configuration

[source,nickel]
----
# pipeline.ncl - Build pipeline definition

let Stage = {
  name : String,
  order : Number,
  enabled : Bool | default = true,
  command : String,
  args : Array String | default = [],
}

let Pipeline = {
  stages : Array Stage,
  parallel : Bool | default = false,
  failFast : Bool | default = true,
}

let DefaultPipeline : Pipeline = {
  stages = [
    { name = "lint", order = 1, command = "deno", args = ["lint"] },
    { name = "check", order = 2, command = "deno", args = ["check", "**/*.ts"] },
    { name = "test", order = 3, command = "deno", args = ["test"] },
    { name = "build", order = 4, command = "deno", args = ["task", "build"] },
  ],
  failFast = true,
}

in DefaultPipeline
----

[[just]]
== Justfile Recipes

=== Complete Justfile Reference

[source,just]
----
# Default recipe - show help
default:
    @just --list

# === BUILD ===

build:
    deno task build

build-verbose:
    deno task build --verbose

build-drafts:
    deno task build --drafts

clean:
    rm -rf dist/ .cache/ coverage/

watch:
    deno task watch

# === TEST ===

test:
    deno test --allow-read --allow-write tests/

test-unit:
    deno test --allow-read --allow-write tests/unit/

test-e2e:
    deno test --allow-read --allow-write --allow-run tests/e2e/

test-coverage:
    deno test --allow-read --allow-write --coverage=coverage/ tests/
    deno coverage coverage/

test-watch:
    deno test --allow-read --allow-write --watch tests/

test-bernoulli:
    deno test --allow-read tests/unit/bernoulli.test.ts

test-all: test-unit test-e2e test-bernoulli

# === TOOLING ===

lsp:
    deno run --allow-read --allow-write noteg-lang/src/lsp/server.ts

compile file:
    deno run --allow-read --allow-write noteg-lang/src/compiler.ts {{file}}

lint:
    deno lint

fmt:
    deno fmt

check:
    deno check **/*.ts

# === DEVELOPMENT ===

dev:
    deno task dev

mcp:
    deno run --allow-read --allow-write --allow-run noteg-mcp/server.ts

codegen:
    deno run --allow-read --allow-write scripts/codegen.ts

# === ADAPTERS ===

test-adapters:
    deno test --allow-read --allow-run adapters/

list-adapters:
    @ls -1 adapters/*.js | xargs -I{} basename {} .js | sort

check-adapters:
    @for f in adapters/*.js; do deno check "$$f" 2>&1 || echo "FAIL: $$f"; done

# === ACCESSIBILITY ===

a11y-validate:
    deno run --allow-read scripts/validate-a11y.ts

a11y-report:
    deno run --allow-read --allow-write scripts/a11y-report.ts

# === CONTAINER ===

container-build:
    podman build -t odd-ssg:latest .

container-run:
    podman run -it --rm -v $(pwd):/app:Z odd-ssg:latest

container-push registry="ghcr.io/hyperpolymath":
    podman push odd-ssg:latest {{registry}}/odd-ssg:latest

# === DOCUMENTATION ===

docs:
    deno run --allow-read --allow-write scripts/gen-docs.ts

docs-serve:
    deno run --allow-read --allow-net scripts/serve-docs.ts

# === RELEASE ===

release version:
    @echo "Preparing release {{version}}..."
    @just test-all
    @just lint
    @just check
    @just docs
    @echo "Release {{version}} ready"

ci:
    @echo "Running CI pipeline..."
    just check
    just lint
    just test-all
    @echo "CI passed!"

pre-commit:
    just fmt
    just lint
    just check
    just test-unit

# === UTILITIES ===

info:
    @echo "odd-ssg - Satellite SSG Adapter Provider"
    @echo "Version: 0.1.0"
    @echo "Adapters: $(ls -1 adapters/*.js | wc -l)"
    @echo "Deno: $(deno --version | head -1)"

update:
    deno cache --reload mod.ts

lock:
    deno cache --lock=deno.lock --lock-write mod.ts

deno +args:
    deno {{args}}
----

=== Recipe Permutations

==== Development Workflows

[source,bash]
----
# Start fresh development session
just clean && just check && just dev

# Full development cycle
just fmt && just lint && just check && just test && just build

# Quick iteration
just test-watch

# Adapter development
just check-adapters && just test-adapters
----

==== Release Workflows

[source,bash]
----
# Full release preparation
just release 0.1.0

# Manual release steps
just clean
just check
just lint
just test-all
just docs
just container-build
----

==== CI/CD Workflows

[source,bash]
----
# Local CI simulation
just ci

# Pre-push validation
just pre-commit && just test-e2e

# Container-based CI
just container-build && just container-run deno task test
----

== Hooks Configuration

=== Git Hooks

==== Pre-commit Hook

[source,bash]
----
#!/bin/bash
# .git/hooks/pre-commit

set -e

echo "Running pre-commit checks..."

# Format check
deno fmt --check

# Lint
deno lint

# Type check
deno check **/*.ts

# Unit tests
deno test --allow-read --allow-write tests/unit/

echo "Pre-commit checks passed!"
----

==== Pre-push Hook

[source,bash]
----
#!/bin/bash
# .git/hooks/pre-push

set -e

echo "Running pre-push validation..."

# Full test suite
just test-all

# Build verification
just build

echo "Pre-push validation passed!"
----

=== MCP Hooks

==== Tool Execution Hook

[source,typescript]
----
// hooks/tool-execution.ts

interface ToolHook {
  before?: (tool: string, args: unknown) => Promise<void>;
  after?: (tool: string, result: unknown) => Promise<void>;
  onError?: (tool: string, error: Error) => Promise<void>;
}

const loggingHook: ToolHook = {
  before: async (tool, args) => {
    console.log(`[${new Date().toISOString()}] Executing: ${tool}`);
  },
  after: async (tool, result) => {
    console.log(`[${new Date().toISOString()}] Completed: ${tool}`);
  },
  onError: async (tool, error) => {
    console.error(`[${new Date().toISOString()}] Failed: ${tool}`, error);
  },
};

export { loggingHook };
----

== Adapter Recipes

=== Using Adapters via MCP

[source,typescript]
----
// Example: Build with Zola adapter

import { MCPClient } from "mcp-client";

const client = new MCPClient();
await client.connect("odd-ssg");

// List available adapters
const adapters = await client.callTool("odd_ssg_list_adapters", {});
console.log("Available adapters:", adapters);

// Connect to Zola
await client.callTool("odd_ssg_connect", { adapter: "zola" });

// Build site
const result = await client.callTool("zola_build", {
  path: "./my-site",
  outputDir: "./dist",
});

console.log("Build result:", result);
----

=== Direct Adapter Usage

[source,typescript]
----
// Example: Using adapter directly

import * as zola from "./adapters/zola.js";

// Check if Zola is available
const connected = await zola.connect();
if (!connected) {
  console.error("Zola not installed");
  Deno.exit(1);
}

// Initialize new site
const initResult = await zola.tools
  .find(t => t.name === "zola_init")!
  .execute({ path: "./new-site" });

// Build the site
const buildResult = await zola.tools
  .find(t => t.name === "zola_build")!
  .execute({ path: "./new-site" });

console.log("Build output:", buildResult.stdout);
----

== Security Best Practices

=== Secure Adapter Execution

[source,typescript]
----
// Always use Deno.Command with args array (never shell strings)

// GOOD: Safe execution
const cmd = new Deno.Command("zola", {
  args: ["build", "--output-dir", outputDir],
  cwd: projectPath,
});

// BAD: Shell injection risk
// const cmd = `zola build --output-dir ${outputDir}`;
// await Deno.run({ cmd: ["bash", "-c", cmd] });
----

=== Permission Model

[source,bash]
----
# Minimal permissions for build
deno run --allow-read=. --allow-write=./dist ssg/src/cli.ts build

# MCP server permissions
deno run --allow-read --allow-write --allow-run=zola,hakyll,serum noteg-mcp/server.ts

# Development with all permissions (use sparingly)
deno run -A ssg/src/cli.ts dev
----

== Index

* <<cli,CLI Commands>>
* <<nickel,Nickel Configuration>>
* <<just,Justfile Recipes>>
